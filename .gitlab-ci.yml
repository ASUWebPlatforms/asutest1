include:
  - project: acquia/standard-template
    file:
      - '/ci-files/jobs/build.yml'
      - '/ci-files/jobs/test.yml'
      - '/ci-files/jobs/deploy.yml'
      - '/ci-files/jobs/manage-cde.yml'
      - '/ci-files/jobs/composer-update.yml'
      - '/ci-files/jobs/replace-deprecated.yml'
      - '/ci-files/jobs/code-beautify.yml'
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml
image: $CONTAINER_IMG
default:
  retry:
    max: 2
    when:
      - scheduler_failure
      - runner_system_failure
      - stuck_or_timeout_failure
    exit_codes: 137
variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_USER: drupal
  MYSQL_PASSWORD: drupal
  MYSQL_DATABASE: drupal
  DB_HOST: mysql
  ACLI_DB_HOST: mysql
  # Valid values are "8.1", "8.2", "8.3", or "8.4"
  PHP_VERSION: ""
  CI_DEBUG_TRACE: "false"
  # FF_USE_LEGACY_KUBERNETES_EXECUTION_STRATEGY: "true"
  STANDARD_TEMPLATE_URL: https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/acquia/standard-template
  STANDARD_TEMPLATE_PATH: $HOME/standard-template
  ACQUIA_JOBS_BUILD_DRUPAL: "true"
  ACQUIA_JOBS_TEST_DRUPAL: "true"
  ACQUIA_JOBS_VALIDATE_CODE: "true"
  # Affects non-blt projects only.
  ACQUIA_TASKS_SETUP_DRUPAL: "false"
  ACQUIA_TASKS_PHPCS: "true"
  ACQUIA_TASKS_PHPCS_EXTRA_ARGS: ""
  ACQUIA_TASKS_PHPSTAN: "true"
  ACQUIA_TASKS_DRUTINY: "false"
  ACQUIA_TASKS_PHPUNIT: "true"
  # Accepted values are "install" and "sync".
  ACQUIA_TASKS_SETUP_DRUPAL_STRATEGY: "install"
  ACQUIA_TASKS_SETUP_DRUPAL_PROFILE: "minimal"
  ACQUIA_TASKS_SETUP_DRUPAL_CONFIG_IMPORT: "true"
  ACQUIA_JOBS_CREATE_BRANCH_ARTIFACT: "true"
  ACQUIA_JOBS_CREATE_TAG_ARTIFACT: "true"
  ACQUIA_JOBS_DEPLOY_TAG_ARTIFACT: "false"
  # If left empty, will default to the production environment.
  ACQUIA_CLOUD_DESTINATION_ENVIRONMENT_ID: ""
  ACQUIA_JOBS_CREATE_CDE: "true"
  # If left empty, will default to first database in database list.
  ACQUIA_CLOUD_SOURCE_DATABASE_NAME: ""
  # If left empty, will default to the production environment.
  ACQUIA_CLOUD_SOURCE_ENVIRONMENT_ID: ""
  ACQUIA_JOBS_DEPRECATED_UPDATE: "true"
  ACQUIA_JOBS_COMPOSER_UPDATE: "true"
  ACQUIA_JOBS_BEAUTIFY_CODE: "false"
  SAST_EXCLUDED_PATHS: "spec, test, tests, tmp, node_modules, vendor, contrib, core"
  SECRET_DETECTION_EXCLUDED_PATHS: "spec, tmp, node_modules, vendor, contrib, core"
  ACQUIA_CUSTOM_CODE_DIRS: "docroot/modules/custom docroot/themes/custom docroot/profiles/custom"
  ACLI_KEY: ${ACQUIA_CLOUD_API_TOKEN_KEY}
  ACLI_SECRET: ${ACQUIA_CLOUD_API_TOKEN_SECRET}
# The cache strategy for the build job.
.cache_strategy_push:
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - $CI_PROJECT_DIR/vendor
      - $CI_PROJECT_DIR/docroot/core
      - $CI_PROJECT_DIR/docroot/modules/contrib
      - $CI_PROJECT_DIR/docroot/themes/contrib
      - $CI_PROJECT_DIR/docroot/profiles/contrib
      - $CI_PROJECT_DIR/drush/Commands/contrib
      - .npm/
# The cache strategy for the test jobs.
.cache_strategy_pull:
  extends: .cache_strategy_push
  cache:
    policy: pull
# Clone the acquia/standard-template to $STANDARD_TEMPLATE_PATH.
.clone_standard_template:
  script:
    - set -e +x
    # @todo Figure out a way to hide the following line from printing to logs. Set +x does not appear to work.
    - echo -e "\e[0Ksection_start:`date +%s`:clone_standard_template[collapsed=true]\r\e[0K\033[1;35m[Code Studio AutoDevOps] Cloning AutoDevOps template\033[0m"
    - git clone --depth 50 $STANDARD_TEMPLATE_URL $STANDARD_TEMPLATE_PATH
    - echo -e "\e[0Ksection_end:`date +%s`:clone_standard_template\r\e[0K"
sast:
  stage: "Test Drupal"
  # We can't apply rules here .
  # @see https://docs.gitlab.com/ee/user/application_security/index.html#error-job-is-used-for-configuration-only-and-its-script-should-not-be-executed
semgrep-sast:
  variables:
    SAST_ANALYZER_IMAGE: $SAST_IMG
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
    - when: never
sobelow-sast:
  variables:
    SAST_ANALYZER_IMAGE: "$SOBELOW_IMG"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
    - when: never
secret_detection:
  stage: "Test Drupal"
  image: $SECRET_DETECTION_IMG
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
    - when: never
stages:
  - "Build Drupal"
  - "Test Drupal"
  - "Automatic Updates"
  - "Deploy Drupal"

"Create artifact from branch":
  before_script:
    - git status
    - git diff
